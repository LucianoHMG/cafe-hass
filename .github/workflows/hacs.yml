name: HACS Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  validate:
    name: HACS Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands

      - name: Validate integration structure
        run: |
          # Check required files exist
          if [ ! -f "custom_components/cafe/manifest.json" ]; then
            echo "❌ Missing manifest.json"
            exit 1
          fi
          
          if [ ! -f "custom_components/cafe/__init__.py" ]; then
            echo "❌ Missing __init__.py"
            exit 1
          fi
          
          if [ ! -f "hacs.json" ]; then
            echo "❌ Missing hacs.json"
            exit 1
          fi
          
          echo "✅ Integration structure is valid"

      - name: Validate manifest.json
        run: |
          # Validate manifest.json structure
          python3 -c "
          import json
          import sys
          
          try:
              with open('custom_components/cafe/manifest.json', 'r') as f:
                  manifest = json.load(f)
              
              required_fields = ['domain', 'name', 'version', 'documentation_url', 'issue_tracker']
              missing_fields = [field for field in required_fields if field not in manifest]
              
              if missing_fields:
                  print(f'❌ Missing required fields in manifest.json: {missing_fields}')
                  sys.exit(1)
              
              print('✅ manifest.json is valid')
          except json.JSONDecodeError as e:
              print(f'❌ Invalid JSON in manifest.json: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'❌ Error validating manifest.json: {e}')
              sys.exit(1)
          "

      - name: Validate hacs.json
        run: |
          # Validate hacs.json structure
          python3 -c "
          import json
          import sys
          
          try:
              with open('hacs.json', 'r') as f:
                  hacs_config = json.load(f)
              
              required_fields = ['name', 'render_readme']
              missing_fields = [field for field in required_fields if field not in hacs_config]
              
              if missing_fields:
                  print(f'❌ Missing required fields in hacs.json: {missing_fields}')
                  sys.exit(1)
              
              print('✅ hacs.json is valid')
          except json.JSONDecodeError as e:
              print(f'❌ Invalid JSON in hacs.json: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'❌ Error validating hacs.json: {e}')
              sys.exit(1)
          "

  validate-frontend:
    name: Validate Frontend Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build frontend
        run: yarn build

      - name: Validate frontend assets
        run: |
          if [ ! -f "custom_components/cafe/www/index.html" ]; then
            echo "❌ Frontend build failed - missing index.html"
            exit 1
          fi
          
          if [ ! -d "custom_components/cafe/www/assets" ]; then
            echo "❌ Frontend build failed - missing assets directory"
            exit 1
          fi
          
          # Check if assets are not empty
          if [ -z "$(ls -A custom_components/cafe/www/assets/)" ]; then
            echo "❌ Frontend assets directory is empty"
            exit 1
          fi
          
          echo "✅ Frontend build is valid"

  update-hacs-version:
    name: Update HACS Version
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version in manifest.json
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          
          # Update manifest.json version
          python3 -c "
          import json
          
          with open('custom_components/cafe/manifest.json', 'r') as f:
              manifest = json.load(f)
          
          manifest['version'] = '${VERSION}'
          
          with open('custom_components/cafe/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          
          print(f'✅ Updated manifest.json version to ${VERSION}')
          "

      - name: Commit version update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add custom_components/cafe/manifest.json
          git diff --staged --quiet || git commit -m "Update version to ${{ github.event.release.tag_name }}"
          git push